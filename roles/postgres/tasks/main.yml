- name: Docker volumes creation
  docker_volume:
    name: "allspark_{{ item }}"
  with_items:
    - artifactory_postgres_data
  when: allspark_artifactory.enabled

- name: Docker network creation
  docker_network:
    name: "allspark_{{ item }}"
  with_items:
    - artifactory_database
  when: allspark_artifactory.enabled
  
- name: Setup PostgreSQL database
  docker_container:
    name: artifactory_database
    image: "{{ downloads.postgresql.image }}:{{ downloads.postgresql.tag }}"
    state: "{{ allspark_artifactory.enabled and 'started' or 'absent'}}"
    env:
      POSTGRES_USER: "artifactory"
      POSTGRES_PASSWORD: "{{ artifactorydb_password }}"
      POSTGRES_DB: "artifactory"
      POSTGRES_INITDB_ARGS: "--data-checksums"
    purge_networks: true
    user: postgres
    networks:
      - name: allspark_artifactory_database
    volumes:
      - "allspark_artifactory_postgres_data:/var/lib/postgresql/data"
    restart_policy: always